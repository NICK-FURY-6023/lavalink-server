# ==============================================================================
# HAProxy Configuration - Multi-IP Rotation (Premium-Grade)
# Production: YouTube Anti-Block, Zero 429, Multi-Region Routing
# ==============================================================================

global
    log stdout format raw local0 info
    maxconn 50000
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option forwardfor
    option http-server-close
    timeout connect 10s
    timeout client  30s
    timeout server  30s
    timeout http-keep-alive 10s
    timeout http-request 10s
    timeout queue 30s
    timeout tunnel 3600s
    retries 3
    option redispatch

# ==============================================================================
# FRONTEND: YouTube Proxy Router (Port 9000)
# ==============================================================================
frontend yt_frontend
    bind *:9000
    mode http
    
    # Request logging
    capture request header Host len 64
    capture request header User-Agent len 128
    capture request header X-Forwarded-For len 64
    
    # Rate limiting (per IP)
    stick-table type ip size 100k expire 5m store http_req_rate(10s),conn_cur
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }
    
    # ACLs for YouTube domains
    acl is_youtube hdr(host) -i -m dom youtube.com
    acl is_youtube hdr(host) -i -m dom googlevideo.com
    acl is_youtube hdr(host) -i -m dom ytimg.com
    acl is_youtube hdr(host) -i -m dom ggpht.com
    acl is_youtube hdr(host) -i -m dom youtube-nocookie.com
    
    # Route to appropriate backend
    use_backend yt_multi_ip if is_youtube
    default_backend yt_multi_ip

# ==============================================================================
# BACKEND: Multi-IP YouTube Proxy Pool (Premium Rotation)
# ==============================================================================
backend yt_multi_ip
    mode http
    balance roundrobin
    option httpchk GET /generate_204 HTTP/1.1\r\nHost:\ connectivitycheck.gstatic.com
    http-check expect status 204
    
    # Health check configuration
    default-server inter 5s fall 3 rise 2 slowstart 60s
    
    # Circuit breaker: Remove failed IPs for 5 minutes
    option allbackups
    
    # Header manipulation for anti-detection
    http-request set-header X-Forwarded-Proto https
    http-request del-header X-Real-IP
    http-request del-header CF-Connecting-IP
    
    # Randomize user agent (premium anti-detection)
    http-request set-header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" if { rand(4) eq 0 }
    http-request set-header User-Agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" if { rand(4) eq 1 }
    http-request set-header User-Agent "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" if { rand(4) eq 2 }
    http-request set-header User-Agent "Mozilla/5.0 (iPhone; CPU iPhone OS 17_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Mobile/15E148 Safari/604.1" if { rand(4) eq 3 }
    
    # ==============================
    # SINGAPORE EXIT NODES (Primary Asia)
    # ==============================
    server sg1 ${SG_IP_1}:443 weight 100 check ssl verify none
    server sg2 ${SG_IP_2}:443 weight 100 check ssl verify none
    
    # ==============================
    # GERMANY EXIT NODES (Primary Europe)
    # ==============================
    server de1 ${DE_IP_1}:443 weight 100 check ssl verify none
    server de2 ${DE_IP_2}:443 weight 100 check ssl verify none
    
    # ==============================
    # US-EAST EXIT NODES (Primary Americas)
    # ==============================
    server us1 ${US_IP_1}:443 weight 100 check ssl verify none
    server us2 ${US_IP_2}:443 weight 100 check ssl verify none
    
    # ==============================
    # BACKUP NODES (Failover)
    # ==============================
    server backup1 ${BACKUP_IP_1}:443 weight 50 check ssl verify none backup
    server backup2 ${BACKUP_IP_2}:443 weight 50 check ssl verify none backup

# ==============================================================================
# FRONTEND: Lavalink Load Balancer (Port 2333)
# ==============================================================================
frontend lavalink_frontend
    bind *:2333
    mode http
    
    # WebSocket support
    acl is_websocket hdr(Upgrade) -i websocket
    acl is_websocket hdr(Connection) -i upgrade
    
    # Authorization header check
    acl has_auth hdr(Authorization) -m found
    
    # Health check endpoint
    acl is_health path /health
    acl is_metrics path /metrics
    
    use_backend lavalink_ws if is_websocket
    use_backend lavalink_rest if has_auth
    use_backend lavalink_health if is_health
    use_backend lavalink_health if is_metrics
    default_backend lavalink_rest

# ==============================================================================
# BACKEND: Lavalink WebSocket (Sticky Sessions)
# ==============================================================================
backend lavalink_ws
    mode http
    balance source
    hash-type consistent
    option httpchk GET /version HTTP/1.1\r\nHost:\ localhost
    http-check expect status 200
    
    # WebSocket settings
    timeout tunnel 3600s
    timeout server 3600s
    
    # Sticky sessions for WebSocket connections
    stick-table type string len 64 size 100k expire 24h
    stick on req.hdr(Authorization)
    
    # Node servers (region-based)
    server node1-sg lavalink-node1:2333 weight 100 check
    server node2-de lavalink-node2:2334 weight 100 check
    server node3-us lavalink-node3:2335 weight 100 check
    server node-backup lavalink-backup:2336 weight 50 check backup

# ==============================================================================
# BACKEND: Lavalink REST API (Load Balanced)
# ==============================================================================
backend lavalink_rest
    mode http
    balance leastconn
    option httpchk GET /version HTTP/1.1\r\nHost:\ localhost
    http-check expect status 200
    
    # Health check intervals
    default-server inter 5s fall 3 rise 2
    
    # REST API servers
    server node1-sg lavalink-node1:2333 weight 100 check
    server node2-de lavalink-node2:2334 weight 100 check
    server node3-us lavalink-node3:2335 weight 100 check
    server node-backup lavalink-backup:2336 weight 50 check backup

# ==============================================================================
# BACKEND: Health Check Endpoint
# ==============================================================================
backend lavalink_health
    mode http
    balance roundrobin
    
    server node1-sg lavalink-node1:2333 check
    server node2-de lavalink-node2:2334 check
    server node3-us lavalink-node3:2335 check

# ==============================================================================
# STATS: HAProxy Statistics Dashboard
# ==============================================================================
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
    stats auth admin:${HAPROXY_STATS_PASSWORD:admin123}
